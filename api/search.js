// ===================================================
// API SEARCH - –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø
// ===================================================

export default async function handler(req, res) {
    console.log('üî• API Search –≤—ã–∑–≤–∞–Ω');
    
    // ======================
    // 1. –ù–ê–°–¢–†–û–ô–ö–ê CORS (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û!)
    // ======================
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Phoenix-Session');
    
    // –û–ë–†–ê–ë–û–¢–ö–ê OPTIONS –ó–ê–ü–†–û–°–ê (–î–õ–Ø CORS)
    if (req.method === 'OPTIONS') {
        console.log('üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é OPTIONS –∑–∞–ø—Ä–æ—Å (CORS)');
        return res.status(200).end();
    }
    
    // ======================
    // 2. –ü–†–û–í–ï–†–ö–ê –ú–ï–¢–û–î–ê
    // ======================
    if (req.method !== 'POST') {
        console.log(`‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥: ${req.method}`);
        return res.status(405).json({ 
            success: false, 
            error: '–¢–æ–ª—å–∫–æ POST –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã',
            method_received: req.method
        });
    }
    
    // ======================
    // 3. –ü–ê–†–°–ò–ù–ì –¢–ï–õ–ê –ó–ê–ü–†–û–°–ê
    // ======================
    let body = {};
    try {
        body = req.body;
        console.log('üìù –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:', JSON.stringify(body).substring(0, 200) + '...');
        
        if (!body || typeof body !== 'object') {
            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞');
        }
        
    } catch (parseError) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–ª–∞:', parseError);
        return res.status(400).json({
            success: false,
            error: '–ù–µ–≤–µ—Ä–Ω—ã–π JSON –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞',
            details: parseError.message
        });
    }
    
    // ======================
    // 4. –ü–†–û–í–ï–†–ö–ê –ó–ê–ü–†–û–°–ê
    // ======================
    const { query, sessionId } = body;
    
    if (!query || query.trim().length < 2) {
        return res.status(400).json({
            success: false,
            error: '–ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞',
            received_query: query || '–ø—É—Å—Ç–æ'
        });
    }
    
    console.log(`üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å: "${query.substring(0, 50)}..."`);
    console.log(`üÜî –°–µ—Å—Å–∏—è: ${sessionId || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`);
    
    // ======================
    // 5. –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–í–ï–¢–ê
    // ======================
    try {
        // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –¢–ò–ü –ó–ê–ü–†–û–°–ê
        const queryLower = query.toLowerCase();
        let responseType = '–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ';
        
        if (queryLower.includes('–ø—Ä–∏–∑–≤–∞–Ω–∏–µ') || queryLower.includes('–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ')) {
            responseType = '–≥–ª—É–±–∏–Ω–Ω—ã–π';
        } else if (queryLower.includes('–ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è') || queryLower.includes('–ª–µ–Ω—å')) {
            responseType = '–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π';
        } else if (queryLower.includes('—Å—Ç—Ä–∞—Ö') || queryLower.includes('–±–æ—é—Å—å')) {
            responseType = '—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π';
        } else if (queryLower.includes('—Å–º—ã—Å–ª') || queryLower.includes('–∂–∏–∑–Ω—å')) {
            responseType = '—Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π';
        } else if (queryLower.includes('–ª—é–±–æ–≤—å') || queryLower.includes('–æ—Ç–Ω–æ—à–µ–Ω')) {
            responseType = '—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π';
        }
        
        // –ë–ê–ó–ê –û–¢–í–ï–¢–û–í
        const responses = {
            '–≥–ª—É–±–∏–Ω–Ω—ã–π': {
                essence: `–ü—Ä–∏–∑–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ, —á—Ç–æ —Ç—ã –Ω–∞—Ö–æ–¥–∏—à—å, –∞ —Ç–æ, —á—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è, –∫–æ–≥–¥–∞ —Ç—ã –Ω–∞—á–∏–Ω–∞–µ—à—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∏–∑ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏. –¢–≤–æ–π –≤–æ–ø—Ä–æ—Å "${query}" ‚Äî —É–∂–µ –ø–µ—Ä–≤—ã–π —à–∞–≥.`,
                resonance: '–ß—Ç–æ –±—ã —Ç—ã –¥–µ–ª–∞–ª, –¥–∞–∂–µ –µ—Å–ª–∏ –±—ã –∑–∞ —ç—Ç–æ –Ω–µ –ø–ª–∞—Ç–∏–ª–∏?',
                step: '–ü—Ä–∞–∫—Ç–∏–∫–∞ "–°–ª–µ–¥ –º–∞—Å—Ç–µ—Ä–∞": –Ω–µ–¥–µ–ª—é –ø–æ—Å–≤—è—â–∞–π 20 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å –¥–µ–ª—É, –∫–æ—Ç–æ—Ä–æ–µ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–±—è –∑–∞–±—ã—Ç—å –æ –≤—Ä–µ–º–µ–Ω–∏.',
                type: '–≥–ª—É–±–∏–Ω–Ω—ã–π'
            },
            '–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π': {
                essence: `–ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è ‚Äî –Ω–µ –≤—Ä–∞–≥, –∞ —Å–∏–≥–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞. –û–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≥–¥–µ —ç–Ω–µ—Ä–≥–∏—è –≤—Å—Ç—Ä–µ—á–∞–µ—Ç —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ. "${query}" —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –º–µ—Å—Ç–æ –¥–ª—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏.`,
                resonance: '–ß—Ç–æ –≤ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º–æ–º –¥–µ–ª–µ –∫–∞–∂–µ—Ç—Å—è –Ω–∞–∏–º–µ–Ω–µ–µ "—Ç–≤–æ–∏–º"?',
                step: '–ú–µ—Ç–æ–¥ "2 –º–∏–Ω—É—Ç—ã": —Å–¥–µ–ª–∞–π —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 2 –º–∏–Ω—É—Ç—ã —Å–∞–º–æ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ –¥–µ–ª–∞. –ù–µ –±–æ–ª—å—à–µ.',
                type: '–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π'
            },
            '—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π': {
                essence: `–≠–º–æ—Ü–∏–∏ ‚Äî —ç—Ç–æ —è–∑—ã–∫ –¥—É—à–∏. "${query}" ‚Äî –ø–µ—Ä–µ–≤–æ–¥ —Å —ç—Ç–æ–≥–æ —è–∑—ã–∫–∞. –ß–µ–º —Å–∏–ª—å–Ω–µ–µ —ç–º–æ—Ü–∏—è, —Ç–µ–º –≤–∞–∂–Ω–µ–µ –ø–æ—Å–ª–∞–Ω–∏–µ.`,
                resonance: '–ì–¥–µ –≤ —Ç–µ–ª–µ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?',
                step: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–∞": 5 –º–∏–Ω—É—Ç –ø—Ä–æ—Å—Ç–æ –æ—Ç–º–µ—á–∞–π –æ—â—É—â–µ–Ω–∏—è –±–µ–∑ –æ—Ü–µ–Ω–∫–∏.',
                type: '—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π'
            },
            '—Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π': {
                essence: `–°–º—ã—Å–ª —Ä–æ–∂–¥–∞–µ—Ç—Å—è –Ω–µ –≤ –æ—Ç–≤–µ—Ç–∞—Ö, –∞ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –≤–æ–ø—Ä–æ—à–∞–Ω–∏—è. "${query}" ‚Äî —ç—Ç–æ —É–∂–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ —Å–º—ã—Å–ª–∞.`,
                resonance: '–ß—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –±—ã—Ç—å –≤–∞–∂–Ω—ã–º, –∫–æ–≥–¥–∞ —Ç—ã –≥–ª—É–±–æ–∫–æ –ø–æ–≥—Ä—É–∂–∞–µ—à—å—Å—è –≤ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å?',
                step: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è "–í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –º–æ–ª—á–∞–Ω–∏–µ": 7 –º–∏–Ω—É—Ç –ø—Ä–æ—Å—Ç–æ –±—É–¥—å —Å –≤–æ–ø—Ä–æ—Å–æ–º.',
                type: '—Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π'
            },
            '–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ': {
                essence: `–ö–∞–∂–¥—ã–π –≥–ª—É–±–æ–∫–∏–π –≤–æ–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–º—è –æ—Ç–≤–µ—Ç–∞. –í "${query}" —É–∂–µ –µ—Å—Ç—å –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å —Å–º–µ–Ω–∏—Ç—å —Ñ–æ–∫—É—Å.`,
                resonance: '–ö–∞–∫–∞—è —á–∞—Å—Ç—å —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ —á—É–≤—Å—Ç–≤—É–µ—Ç—Å—è —Å–∞–º–æ–π –∂–∏–≤–æ–π?',
                step: '–°–≤–æ–±–æ–¥–Ω–æ–µ –ø–∏—Å—å–º–æ: 5 –º–∏–Ω—É—Ç –ø–∏—à–∏ –≤—Å—ë, —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –≥–æ–ª–æ–≤—É –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ.',
                type: '–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ'
            }
        };
        
        const responseTemplate = responses[responseType] || responses['–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ'];
        
        // –ö–û–õ–õ–ï–ö–¢–ò–í–ù–ê–Ø –ú–£–î–†–û–°–¢–¨
        const collectiveData = {
            peopleCount: Math.floor(Math.random() * 200) + 50,
            message: `${Math.floor(Math.random() * 200) + 50} —á–µ–ª–æ–≤–µ–∫ –∏—Å–∫–∞–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ –ø–æ—Ö–æ–∂–∏–π –≤–æ–ø—Ä–æ—Å`,
            similarQuestions: [
                { query: '–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–≤–æ–π –ø—É—Ç—å –≤ –∂–∏–∑–Ω–∏?' },
                { query: '–í —á—ë–º —Å–º—ã—Å–ª –º–æ–µ–≥–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è?' },
                { query: '–ö–∞–∫ –æ–±—Ä–µ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≥–∞—Ä–º–æ–Ω–∏—é?' }
            ]
        };
        
        // –§–û–†–ú–ò–†–£–ï–ú –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢
        const finalResponse = {
            success: true,
            source: 'phoenix_api_v6',
            response: {
                essence: responseTemplate.essence,
                resonance: responseTemplate.resonance,
                step: responseTemplate.step,
                type: responseTemplate.type
            },
            collective: collectiveData,
            debug: {
                timestamp: new Date().toISOString(),
                query_length: query.length,
                response_type: responseType,
                processing_time: 'instant'
            }
        };
        
        console.log(`‚úÖ –û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (—Ç–∏–ø: ${responseType})`);
        console.log(`üìä –ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–∞—è –º—É–¥—Ä–æ—Å—Ç—å: ${collectiveData.peopleCount} —á–µ–ª–æ–≤–µ–∫`);
        
        // –í–û–ó–í–†–ê–©–ê–ï–ú –£–°–ü–ï–®–ù–´–ô –û–¢–í–ï–¢
        return res.status(200).json(finalResponse);
        
    } catch (error) {
        // –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ API:', error);
        
        const fallbackResponse = {
            success: true, // –í—Å–µ —Ä–∞–≤–Ω–æ true, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –Ω–µ —Å–ª–æ–º–∞–ª—Å—è
            source: 'fallback',
            response: {
                essence: `–î–∞–∂–µ –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º—ã –¥–∞—é—Ç —Å–±–æ–π, –ø–æ–∏—Å–∫ —Å–º—ã—Å–ª–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è. –¢–≤–æ–π –≤–æ–ø—Ä–æ—Å "${query}" –≤–∞–∂–µ–Ω —Å–∞–º –ø–æ —Å–µ–±–µ.`,
                resonance: '–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏, –∫–æ–≥–¥–∞ –≤–Ω–µ—à–Ω–∏–µ –æ—Ç–≤–µ—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã?',
                step: '–ü–∞—É–∑–∞ –Ω–∞ —á–∞–π: –ø—Ä–∏–≥–æ—Ç–æ–≤—å –Ω–∞–ø–∏—Ç–æ–∫ –∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–π –∑–∞ –ø–∞—Ä–æ–º 5 –º–∏–Ω—É—Ç.',
                type: '—Ä–µ–∑–µ—Ä–≤–Ω—ã–π'
            },
            collective: {
                peopleCount: 1,
                message: '–ò–Ω–æ–≥–¥–∞ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –ø–æ–∏—Å–∫–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ',
                similarQuestions: []
            },
            error: error.message
        };
        
        return res.status(200).json(fallbackResponse);
    }
}

// ===================================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –ø–æ–∑–∂–µ)
// ===================================================
function analyzeQueryDepth(query) {
    // –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ –≥–ª—É–±–∏–Ω—ã –≤–æ–ø—Ä–æ—Å–∞
    const depthIndicators = [
        '–ø–æ—á–µ–º—É', '–∑–∞—á–µ–º', '—Å–º—ã—Å–ª', '–∂–∏–∑–Ω—å', '—Å–º–µ—Ä—Ç—å',
        '–≤–µ—á–Ω–æ—Å—Ç—å', '–±–æ–≥', '–¥—É—à–∞', '–ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ'
    ];
    
    let depthScore = 0;
    const queryLower = query.toLowerCase();
    
    depthIndicators.forEach(indicator => {
        if (queryLower.includes(indicator)) depthScore++;
    });
    
    return {
        score: depthScore,
        level: depthScore > 3 ? '–≥–ª—É–±–æ–∫–∏–π' : depthScore > 1 ? '—Å—Ä–µ–¥–Ω–∏–π' : '–ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π'
    };
}
